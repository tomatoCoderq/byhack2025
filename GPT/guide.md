# Руководство: как пользоваться генераторами диалога и концовки

Этот проект создаёт учебные диалоги на русском и татарском для детского приложения и строит концовку истории с учётом выбранных веток.

## Состав

- Пакет (ваш модуль):  
  `AnswerStructure.py`, `prompts.py`, `Params.py`, `GPTrequest.py`, `__init__.py`
- Скрипты вызова:
  - `generate_dialog.py` — генерирует узел диалога
  - `generate_ending.py` — генерирует финал (включая краткое описание и полноценную историю)

> В скриптах замените `yourpkg` на фактическое имя вашего пакета (папки с `__init__.py`).

---

## Требования

- Python 3.10+
- Зависимости:
  ```bash
  pip install openai python-dotenv
  ```
- Переменная окружения с ключом OpenAI:
  - Файл `.env` в корне проекта:
    ```env
    OPENAI_API_KEY=sk-...ваш-ключ...
    ```

---

## Быстрый старт

### 1) Генерация диалога

```bash
python generate_dialog.py
```

Вывод: **JSON** узла диалога в консоль.  
Структура (сокращённо):

```json
{
  "initial_npc_phrase_ru": "...",
  "initial_npc_phrase_tt": "...",
  "initial_options": [
    {"id":"G1","type":"good","text_ru":"...","text_tt":"..."},
    {"id":"G2","type":"good","text_ru":"...","text_tt":"..."},
    {"id":"B1","type":"bad","text_ru":"...","text_tt":"..."},
    {"id":"B2","type":"bad","text_ru":"...","text_tt":"..."}
  ],
  "good_branches": [...],
  "bad_branches": [...]
}
```

### 2) Генерация концовки

```bash
python generate_ending.py
```

Скрипт генерирует диалог, затем по списку выбранных веток (`PLAYER_PATH`) строит финал.  
Вывод: **JSON** финала в консоль.

---

## Как указать, какие ветки прошёл игрок

В `generate_ending.py` есть переменная:

```python
PLAYER_PATH = [("good", 0), ("bad", 1)]
```

Каждый элемент — это кортеж вида `("good" или "bad", индекс)`.  
Примеры:

- Две хорошие ветки:  
  ```python
  PLAYER_PATH = [("good", 0), ("good", 1)]
  ```
- Две плохие ветки:  
  ```python
  PLAYER_PATH = [("bad", 0), ("bad", 1)]
  ```
- Смешанный путь:  
  ```python
  PLAYER_PATH = [("good", 1), ("bad", 0)]
  ```

Алгоритм автоматически определяет тон (`tone_plan`) финала:  
- 2 good → `good`  
- 2 bad → `bad`  
- good + bad → `mixed`  

---

## Настройка персонажа и стиля

Скрипты передают в промпт параметры:
- `style` — общий художественный стиль,
- `persona` — характер/манера речи NPC (Шурале).

---

## Интеграция в игру

1. Вызовите генерацию диалога при входе в сцену.
2. Отобразите первую реплику NPC и варианты ответов игрока.
3. По клику пользователя переходите в соответствующую ветку.
4. Сохраняйте последовательность веток, которые прошёл игрок.
5. В конце сцены вызовите генерацию финала с этим путём и отрендерьте результат.

---

## Частые ошибки

- **KeyError: OPENAI_API_KEY** — проверьте `.env` и вызов `load_dotenv()`.
- **Всегда хорошие концовки** — убедитесь, что `PLAYER_PATH` отражает реальные выборы игрока.
- **Кириллица в JSON заменяется на \uXXXX** — используйте `ensure_ascii=False` (уже настроено в коде).

---

## Быстрые команды

```bash
# Генерация диалога
python generate_dialog.py

# Генерация концовки
python generate_ending.py
```
